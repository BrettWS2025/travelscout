name: Whats on and Events

on:
  workflow_dispatch:
  schedule:
    - cron: "17 16 * * 1"   # Mon 16:17 UTC (Tue morning NZT)

permissions:
  contents: write   # allow committing updated data

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run spiders (parallel, fast) -> canonical filenames
        working-directory: scraper
        run: |
          mkdir -p data

          # EVENTS (Christchurch "What's On")
          python -m scrapy crawl christchurch_whats_on \
            -s CONCURRENT_REQUESTS=16 -s CONCURRENT_REQUESTS_PER_DOMAIN=16 \
            -s DOWNLOAD_DELAY=0.25 -s AUTOTHROTTLE_ENABLED=1 \
            -O data/Events.jsonl &

          # THINGS TO DO (Christchurch attractions/activities)
          python -m scrapy crawl christchurch_things \
            -s CONCURRENT_REQUESTS=16 -s CONCURRENT_REQUESTS_PER_DOMAIN=16 \
            -s DOWNLOAD_DELAY=0.25 -s AUTOTHROTTLE_ENABLED=1 \
            -O data/Things_to_do.jsonl &

          wait

      - name: Detect data changes
        id: detect
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add scraper/data/Events.jsonl scraper/data/Things_to_do.jsonl 2>/dev/null || true
          if git diff --cached --quiet -- scraper/data/Events.jsonl scraper/data/Things_to_do.jsonl; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit scraped data
        if: steps.detect.outputs.changed == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          git commit -m "data: update Events/Things_to_do ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push

      - name: Upload artifact (only when changed)
        if: steps.detect.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: nz-events-and-things-jsonl
          path: |
            scraper/data/Events.jsonl
            scraper/data/Things_to_do.jsonl
