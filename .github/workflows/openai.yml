name: Analyze deals with OpenAI

on:
  workflow_dispatch: {}
  # To run automatically each day, uncomment one of the schedules below.
  # NOTE: GitHub schedules use UTC and do not adjust for NZ daylight saving.
  # - 06:00 NZDT ≈ 17:00 UTC
  # - 06:00 NZST ≈ 18:00 UTC
  # schedule:
  #   - cron: "0 17 * * *"  # ~06:00 NZDT
  #   - cron: "0 18 * * *"  # ~06:00 NZST

permissions:
  contents: write

concurrency:
  group: analyze-deals
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # If your requirements.txt is at the repo root, use:
          # pip install -r requirements.txt
          # If it lives under scraper/, keep the line below:
          pip install -r scraper/requirements.txt

      # Optional: quick visibility into your dataset on the runner
      # - name: Debug list data dir
      #   run: |
      #     ls -la public/data || true
      #     wc -l public/data/packages.final*.jsonl || true

- name: Run analysis script
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    OPENAI_MODEL: gpt-4o-mini
    TOP_N: 20              # only write the Top 20 per-deal JSONs
    SHORTLIST_SIZE: 400    # optional: analyze only the best 400 by heuristic
    MAX_DEALS: 50         # leave 0 to consider all (after nights filter)
  run: |
    python scraper/scripts/analyze_deals.py

      - name: Commit and push generated report (if any changes)
        run: |
          set -e

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Make sure we have the latest remote history
          git fetch origin main

          # Stage everything created by the script
          git add -A

          # If nothing is staged, exit quietly
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # Commit first (so the index is clean before rebase)
          git commit -m "chore(reports): OpenAI Top 10 deals $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          # Rebase our new commit(s) onto the latest remote main
          git pull --rebase --autostash origin main

          # Push safely
          git push origin HEAD:main
