name: Analyze deals with OpenAI

on:
  workflow_dispatch: {}
  # To run automatically each day, uncomment one of the schedules below.
  # NOTE: GitHub schedules use UTC and do not adjust for NZ daylight saving.
  # - 06:00 NZDT ≈ 17:00 UTC
  # - 06:00 NZST ≈ 18:00 UTC
  # schedule:
  #   - cron: "0 17 * * *"  # ~06:00 NZDT
  #   - cron: "0 18 * * *"  # ~06:00 NZST

permissions:
  contents: write

concurrency:
  group: analyze-deals
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run analysis script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini
          # Optional while testing to save cost/time, e.g. only first 25 deals:
          # MAX_DEALS: 25
        run: |
          python scraper/scripts/analyze_deals.py

      - name: Commit and push generated report (if any changes)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage all changes from the run
          git add -A

          # Exit early if nothing changed
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # Rebase on latest remote main to avoid non-fast-forward errors
          git fetch origin main
          git rebase origin/main || git rebase --abort

          # Commit and push
          git commit -m "chore(reports): OpenAI Top 10 deals $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push --with-lease origin HEAD:main
